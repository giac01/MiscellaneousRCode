---
title: "Confusion about spread_draws"
format: 
  html:
    code-fold: true
editor: visual
cache: true
---

## Load data 

```{r}
library(brms)
library(tidyverse)
library(tidybayes)
data_long_summarised = readRDS(file = file.path("data","osf_hedge_cwzds","data_long_summarised.Rds"))

data_long_summarised
```

## Fit model

```{r}

model_time_1 = brms::brm(
  n_go | trials(n) ~  1 + condition_contrast + (1 + condition_contrast | pps),
  # family = binomial(link = "probit"),
  family = binomial(link = "logit"),
  data = filter(data_long_summarised, session == 1 ),
  cores   = 2,
  chains  = 2,
  iter    = 10000,
  # init    = .01,
  adapt_delta = .95,
  backend = "cmdstanr",
  threads = threading(4),
  save_warmup = FALSE,
  refresh = 2000
)

```

## Model Output

```{r}
model_time_1

```

```{r}

tidybayes::get_variables(model_time_1)
```

## Extract draws using spread_draws

spread_draws to get posterior draws for participant 1 on the condition_contrast coefficient.

Weirdly, its giving me 20,000 draws for each participant. I don't understand this as

```{r}

subj_draws_time_1 = model_time_1 %>%
  tidybayes::spread_draws(r_pps[pps,condition_contrast]) 

subj_draws_time_1$pps %>% table()

pps_1_draws = model_time_1 %>%
  tidybayes::spread_draws(r_pps[pps,condition_contrast]) %>%
  filter(pps == 1)

```

## brms to get same posterior draws

```{r}

subj_draws_time_1_brms = as_draws_df(model_time_1) %>%
                    select(ends_with("condition_contrast]")) 

pps_1_draws_brms = subj_draws_time_1_brms$`r_pps[1,condition_contrast]`

```

## Comparison 

In both cases i want to analyse the posterior distribution for participant 1.

The first 10,000 draws from pps_1_draws (spread_draws output) match up to the brms output, but the second 10,000 draws look very different.

```{r}


hist(pps_1_draws_brms)
hist(pps_1_draws$r_pps[1:10000])
hist(pps_1_draws$r_pps[10001:20000])

mean(pps_1_draws_brms)
mean(pps_1_draws$r_pps[1:10000])
mean(pps_1_draws$r_pps[10001:20000])


```

I've checked and its not the case that the first 10,000 draws are from chain 1:

```{r}
table(pps_1_draws$.chain[1:10000])
```

Anyway, I'm a little confused if there's something i've done wrong here or if there's been a strange interaction with brms here.

My setup:

```{r}

sessionInfo()
```
